"use strict";angular.module("imageTaggingApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","ngImgMap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"DemoCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).otherwise({redirectTo:"/"})}]),!function(a){a.module("ngImgMap",[]).factory("ngImgMapCurArea",["$document",function(b){function c(a){a[0]>a[2]&&d(a,0,2),a[1]>a[3]&&d(a,1,3)}function d(a,b,c){var d=a[b];a[b]=a[c],a[c]=d}var e={area:void 0,mouse:[0,0],action:void 0};return b.find("body").on("mouseup",function(b){a.isDefined(e.area)&&(c(e.area.coords),delete e.area.isDraging,e.area=void 0)}),e}]).factory("ngImgMapCalculation",["$timeout",function(b){function c(a,b,c){return a>c?c:b>a?b:a}var d=function(a,b){this.dx=0,this.dy=0,this.imgw=a[0],this.imgh=a[1],this.img=[this.imgw,this.imgh],this.canw=Math.min(a[0],b[0]),this.ratio=a[0]&&this.canw?this.canw/a[0]:1};return d.prototype.init=function(a,b,c){var d=this;if(d._getOffset(b,c),0==d.dx&&0==d.dy)return!1;switch(d.curA=b,d.coords=d.curA.area.coords,d.curA.mouse=c,a[0]){case"move":d._move();break;case"resize":d._resize(a[1])}},d.prototype.getDragAction=function(b){var c=b.split(" "),d="move",e=[0,0,0,0];return a.forEach(c,function(b){switch(b){case"bar-remove":d=void 0;break;case"dragline":case"dragdot":d="resize";break;default:var c=new RegExp("ord-([nswe]+)").exec(b)||[];if(c.length){var f=c[1].split("");a.forEach(f,function(a){switch(a){case"w":e[0]=1;break;case"n":e[1]=1;break;case"e":e[2]=1;break;case"s":e[3]=1}})}}}),[d,e]},d.prototype.checkCoords=function(a){a[0]=+a[0]||0,a[1]=+a[1]||0,a[2]=+a[2]||0,a[3]=+a[3]||0;var b=this,d=0,e=0,f=a[0],g=a[1],h=a[2],i=a[3];if(0>f&&(d=-f,f=h=1),h>b.imgw&&(d=b.imgw-h,f=h=1),0>g&&(e=-g,g=i=1),i>b.imgh&&(e=b.imgh-i,g=i=1),(f||g)&&(a[0]+=f*d,a[1]+=g*e,a[2]+=h*d,a[3]+=i*e),Math.abs(a[0]-a[2])>b.imgw||Math.abs(a[1]-a[3])>b.imgh)for(var j=0,k=a.length;k>j;j++)a[j]=c(a[j],0,b.img[j%2]);return a},d.prototype._getOffset=function(a,b){var c=this;c.dx=parseInt((b[0]-a.mouse[0])/c.ratio),c.dy=parseInt((b[1]-a.mouse[1])/c.ratio)},d.prototype._move=function(){var a=this;a._checkEdge(a.coords,[a.coords[0]+a.dx,a.coords[1]+a.dy,a.coords[2]+a.dx,a.coords[3]+a.dy],[1,1,1,1])},d.prototype._resize=function(a){var b=this;b._checkEdge(b.coords,[b.coords[0]+b.dx*a[0],b.coords[1]+b.dy*a[1],b.coords[2]+b.dx*a[2],b.coords[3]+b.dy*a[3]],a)},d.prototype._checkEdge=function(a,b,c){for(var d=this,e=0,f=b.length;f>e;e++)if(b[e]>d.img[e%2]||b[e]<0){b[e]=a[e];var g=(e+2)%4;c[g]&&(b[g]=a[g])}d.curA.area.coords=b},d}]).controller("ngImgMapCtrl",["$scope","ngImgMapCalculation","ngImgMapCurArea",function(b,c,d){function e(){return f=b.ngImgMapFns,g=b.m=b.ngModel,a.isUndefined(g)?console.warn("ngImgMap need correct ngModel, please check data & format!"):(f&&a.isFunction(f.getImgSize)?h=f.getImgSize(g)||[1e3,100]:(h=[1e3,100],console.warn("ngImgMap need fn to get ImgSize, now use [1000, 100] !")),f&&a.isFunction(f.getCanSize)?i=f.getCanSize(g)||[1e3,100]:(i=[1e3,100],console.warn("ngImgMap need fn to get CanSize, now use [1000, 100] !")),j=new c(h,i),k=j.ratio,g.getCalculation=function(){return j},a.isDefined(g)&&a.forEach(g.maps,function(a){j.checkCoords(a.coords)}),void(b.wrapperStyle=function(){var a=j.img;return{width:a[0]*k+"px",height:a[1]*k+"px","background-image":"url("+g.pic_url+")"}}()))}var f,g,h,i,j,k,l=d,m=null;e(),b.$watch("m.pic_url",function(){j&&e()}),b.catchArea=function(b,c){b.preventDefault(),b.stopPropagation(),a.isDefined(c)&&c.coords&&(m=c,l.area=c,l.mouse=[b.pageX,b.pageY],l.action=j.getDragAction(b.target.className),["move","resize"].indexOf(l.action[0])>-1&&(l.area.isDraging=!0))},b.trackMouse=function(b){if(b.stopPropagation(),m==l.area){var c=l.action;a.isDefined(l.area)&&a.isDefined(c[0])&&l.area.coords&&j.init(c,l,[b.pageX,b.pageY])}},b.removeArea=function(b,c){a.isDefined(b[c])&&b.splice(c,1)},b.getAreaStyle=function(a){var b=a.coords||[10,10,50,50];return{width:parseInt(Math.abs(b[0]-b[2])*k)+"px",height:parseInt(Math.abs(b[1]-b[3])*k)+"px",left:parseInt(Math.min(b[0],b[2])*k)+"px",top:parseInt(Math.min(b[1],b[3])*k)+"px"}},b.getCurSize=function(a){var b=Math.abs(a[2]-a[0]),c=Math.abs(a[3]-a[1]);return[b,c].join(" * ")}}]).directive("ngImgMap",["$timeout",function(a){return{restrict:"EA",scope:{ngImgMapFns:"=ngImgMapFns",ngModel:"=ngModel"},templateUrl:"ngImgMap.html",controller:"ngImgMapCtrl"}}]).run(["$templateCache",function(a){var b='<div class="img-map-wrapper" ng-mousemove="trackMouse($event)" ng-style="wrapperStyle">    <div ng-repeat="area in m.maps" class="map-area" ng-mousedown="catchArea($event, area)" ng-class="{draging: area.isDraging}" ng-style="getAreaStyle(area)">        <div class="dragbar">            <div class="bar-title">{{$index+1}}</div>            <div class="bar-remove" ng-click="removeArea(m.maps, $index)">&times;</div>            <div class="bar-size">{{getCurSize(area.coords)}}</div>            <div class="bar-coords">{{area.coords}}</div>        </div>        <div class="ord-n dragline"></div>        <div class="ord-e dragline"></div>        <div class="ord-s dragline"></div>        <div class="ord-w dragline"></div>        <div class="ord-n dragdot"></div>        <div class="ord-e dragdot"></div>        <div class="ord-s dragdot"></div>        <div class="ord-w dragdot"></div>        <div class="ord-nw dragdot"></div>        <div class="ord-ne dragdot"></div>        <div class="ord-sw dragdot"></div>        <div class="ord-se dragdot"></div>    </div></div>';a.put("ngImgMap.html",b)}])}(angular);var app=angular.module("imageTaggingApp");app.controller("DemoCtrl",["$scope","fileReader",function(a,b){function c(a){var b=new RegExp("(\\d+)x(\\d+)."),c=b.exec(a);return c&&c.length>1?c.slice(1):!1}a.imageSrc="",console.log(a.imageSrc),a.$on("fileProgress",function(b,c){a.progress=c.loaded/c.total}),a.img={pic_url:"images/map.8ecd1615.png"},a.showType=function(b){a.name=b,alert(a.name+" clicked")},a.mapFns={getCanSize:function(){return[950,1e3]},getImgSize:function(b){return c(a.img.pic_url)||[550,400]}},a.addArea=function(a){a&&a.maps&&angular.isArray(a.maps)||(a=angular.isObject(a)?a:{},a.maps=[]);var b=a.getCalculation(),c=a.maps.slice(-1)[0],d=c?c.coords[0]:0,e=c?c.coords[1]:0,f=[d+30,e+30,d+100,e+100];b?a.maps.push({coords:b.checkCoords(f)}):a.maps.push({coords:f})},a.catchArea=function(a){a.isDraging=!0},a.releaseArea=function(a){a.hasOwnProperty("isDraging")&&delete a.isDraging},a.$watch("img",function(b,c){a.imgJson=angular.toJson(b,!0)},!0)}]),app.directive("ngFileSelect",["fileReader","$timeout",function(a,b){return{scope:{ngModel:"="},link:function(c,d){function e(d){a.readAsDataUrl(d,c).then(function(a){b(function(){c.ngModel=a})})}d.bind("change",function(a){var b=(a.srcElement||a.target).files[0];e(b)})}}}]),app.factory("fileReader",["$q","$log",function(a,b){var c=function(a,b,c){return function(){c.$apply(function(){b.resolve(a.result)})}},d=function(a,b,c){return function(){c.$apply(function(){b.reject(a.result)})}},e=function(a,b){return function(a){b.$broadcast("fileProgress",{total:a.total,loaded:a.loaded})}},f=function(a,b){var f=new FileReader;return f.onload=c(f,a,b),f.onerror=d(f,a,b),f.onprogress=e(f,b),f},g=function(b,c){var d=a.defer(),e=f(d,c);return e.readAsDataURL(b),d.promise};return{readAsDataUrl:g}}]),angular.module("imageTaggingApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("imageTaggingApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/main.html",'<div class="container"> <div class="row"> <div class="col-md-6"> <form> <!-- <input type="file" ng-file-select="onFileSelect($files)" ng-model="imageSrc"> --> <!--  <input type="file" ng-file-select="onFileSelect($files)" multiple> --> </form> </div> <div class="col-md-6"> <img ng-src="{{imageSrc}}" class="img-responsive"> </div> </div> </div> <div class="col-md-6"> <div ng-img-map ng-img-map-fns="mapFns" ng-model="img"></div> <div class="row" style="padding:0px 50px"> <button class="btn btn-success" ng-click="addArea(img)" style="margin-top: 20px">add area</button> <div class="col-md-12"> <div class="col-md-12" ng-repeat="m in img.maps" style="margin: 5px 0"> <div class="row"> <div class="pull-left"> <h5>Area {{$index+1}}: </h5></div> <div class="col-md-5"> <label class="block" for="">Title</label> <input class="form-control" type="text" ng-model="m.title" ng-focus="catchArea(m)" ng-blur="releaseArea(m)"> </div> <div class="col-md-5"> <label class="block" for="">Description</label> <input class="form-control" type="text" ng-model="m.description" ng-focus="catchArea(m)" ng-blur="releaseArea(m)"> </div> </div> </div> </div> </div> </div> <div class="col-md-6"> <!-- <div>Live Data</div>\n  <pre>{{imgJson}}</pre> --> <div style="text-align:center"> <div> <img class="map" ng-src="{{img.pic_url}}" class="demo-img" usemap="#ImgExam"> <map name="ImgExam" style="position:relative"> <area class="area" ng-click="showType(area.title)" style="outline: #000 solid 2px" shape="rect" coords="{{area.coords.join()}}" ng-repeat="area in img.maps" ng-href="{{area.link_url || \'javascript:void(0)\'}}" title="{{area.title}}" target="_blank"> </map> </div> </div> </div> <script type="text/javascript">$(function() {\n  $(\'.map\').maphilight({fade: false});\n});</script>')}]);