"use strict";angular.module("imageTaggingApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","ngImgMap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"DemoCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).otherwise({redirectTo:"/"})}]),!function(a){a.module("ngImgMap",[]).factory("ngImgMapCurArea",["$document",function(b){function c(a){a[0]>a[2]&&d(a,0,2),a[1]>a[3]&&d(a,1,3)}function d(a,b,c){var d=a[b];a[b]=a[c],a[c]=d}var e={area:void 0,mouse:[0,0],action:void 0};return b.find("body").on("mouseup",function(b){a.isDefined(e.area)&&(c(e.area.coords),delete e.area.isDraging,e.area=void 0)}),e}]).factory("ngImgMapCalculation",["$timeout",function(b){function c(a,b,c){return a>c?c:b>a?b:a}var d=function(a,b){this.dx=0,this.dy=0,this.imgw=a[0],this.imgh=a[1],this.img=[this.imgw,this.imgh],this.canw=Math.min(a[0],b[0]),this.ratio=a[0]&&this.canw?this.canw/a[0]:1};return d.prototype.init=function(a,b,c){var d=this;if(d._getOffset(b,c),0==d.dx&&0==d.dy)return!1;switch(d.curA=b,d.coords=d.curA.area.coords,d.curA.mouse=c,a[0]){case"move":d._move();break;case"resize":d._resize(a[1])}},d.prototype.getDragAction=function(b){var c=b.split(" "),d="move",e=[0,0,0,0];return a.forEach(c,function(b){switch(b){case"bar-remove":d=void 0;break;case"dragline":case"dragdot":d="resize";break;default:var c=new RegExp("ord-([nswe]+)").exec(b)||[];if(c.length){var f=c[1].split("");a.forEach(f,function(a){switch(a){case"w":e[0]=1;break;case"n":e[1]=1;break;case"e":e[2]=1;break;case"s":e[3]=1}})}}}),[d,e]},d.prototype.checkCoords=function(a){a[0]=+a[0]||0,a[1]=+a[1]||0,a[2]=+a[2]||0,a[3]=+a[3]||0;var b=this,d=0,e=0,f=a[0],g=a[1],h=a[2],i=a[3];if(0>f&&(d=-f,f=h=1),h>b.imgw&&(d=b.imgw-h,f=h=1),0>g&&(e=-g,g=i=1),i>b.imgh&&(e=b.imgh-i,g=i=1),(f||g)&&(a[0]+=f*d,a[1]+=g*e,a[2]+=h*d,a[3]+=i*e),Math.abs(a[0]-a[2])>b.imgw||Math.abs(a[1]-a[3])>b.imgh)for(var j=0,k=a.length;k>j;j++)a[j]=c(a[j],0,b.img[j%2]);return a},d.prototype._getOffset=function(a,b){var c=this;c.dx=parseInt((b[0]-a.mouse[0])/c.ratio),c.dy=parseInt((b[1]-a.mouse[1])/c.ratio)},d.prototype._move=function(){var a=this;a._checkEdge(a.coords,[a.coords[0]+a.dx,a.coords[1]+a.dy,a.coords[2]+a.dx,a.coords[3]+a.dy],[1,1,1,1])},d.prototype._resize=function(a){var b=this;b._checkEdge(b.coords,[b.coords[0]+b.dx*a[0],b.coords[1]+b.dy*a[1],b.coords[2]+b.dx*a[2],b.coords[3]+b.dy*a[3]],a)},d.prototype._checkEdge=function(a,b,c){for(var d=this,e=0,f=b.length;f>e;e++)if(b[e]>d.img[e%2]||b[e]<0){b[e]=a[e];var g=(e+2)%4;c[g]&&(b[g]=a[g])}d.curA.area.coords=b},d}]).controller("ngImgMapCtrl",["$scope","ngImgMapCalculation","ngImgMapCurArea",function(b,c,d){function e(){return f=b.ngImgMapFns,g=b.m=b.ngModel,a.isUndefined(g)?console.warn("ngImgMap need correct ngModel, please check data & format!"):(f&&a.isFunction(f.getImgSize)?h=f.getImgSize(g)||[1e3,100]:(h=[1e3,100],console.warn("ngImgMap need fn to get ImgSize, now use [1000, 100] !")),f&&a.isFunction(f.getCanSize)?i=f.getCanSize(g)||[1e3,100]:(i=[1e3,100],console.warn("ngImgMap need fn to get CanSize, now use [1000, 100] !")),j=new c(h,i),k=j.ratio,g.getCalculation=function(){return j},a.isDefined(g)&&a.forEach(g.maps,function(a){j.checkCoords(a.coords)}),void(b.wrapperStyle=function(){var a=j.img;return{width:a[0]*k+"px",height:a[1]*k+"px","background-image":"url("+g.pic_url+")"}}()))}var f,g,h,i,j,k,l=d,m=null;e(),b.$watch("m.pic_url",function(){j&&e()}),b.catchArea=function(b,c){b.preventDefault(),b.stopPropagation(),a.isDefined(c)&&c.coords&&(m=c,l.area=c,l.mouse=[b.pageX,b.pageY],l.action=j.getDragAction(b.target.className),["move","resize"].indexOf(l.action[0])>-1&&(l.area.isDraging=!0))},b.trackMouse=function(b){if(b.stopPropagation(),m==l.area){var c=l.action;a.isDefined(l.area)&&a.isDefined(c[0])&&l.area.coords&&j.init(c,l,[b.pageX,b.pageY])}},b.removeArea=function(b,c){a.isDefined(b[c])&&b.splice(c,1)},b.getAreaStyle=function(a){var b=a.coords||[10,10,50,50];return{width:parseInt(Math.abs(b[0]-b[2])*k)+"px",height:parseInt(Math.abs(b[1]-b[3])*k)+"px",left:parseInt(Math.min(b[0],b[2])*k)+"px",top:parseInt(Math.min(b[1],b[3])*k)+"px"}},b.getCurSize=function(a){var b=Math.abs(a[2]-a[0]),c=Math.abs(a[3]-a[1]);return[b,c].join(" * ")}}]).directive("ngImgMap",["$timeout",function(a){return{restrict:"EA",scope:{ngImgMapFns:"=ngImgMapFns",ngModel:"=ngModel"},templateUrl:"ngImgMap.html",controller:"ngImgMapCtrl"}}]).run(["$templateCache",function(a){var b='<div class="img-map-wrapper" ng-mousemove="trackMouse($event)" ng-style="wrapperStyle">    <div ng-repeat="area in m.maps" class="map-area" ng-mousedown="catchArea($event, area)" ng-class="{draging: area.isDraging}" ng-style="getAreaStyle(area)">        <div class="dragbar">            <div class="bar-title">{{$index+1}}</div>            <div class="bar-remove" ng-click="removeArea(m.maps, $index)">&times;</div>            <div class="bar-size">{{getCurSize(area.coords)}}</div>            <div class="bar-coords">{{area.coords}}</div>        </div>        <div class="ord-n dragline"></div>        <div class="ord-e dragline"></div>        <div class="ord-s dragline"></div>        <div class="ord-w dragline"></div>        <div class="ord-n dragdot"></div>        <div class="ord-e dragdot"></div>        <div class="ord-s dragdot"></div>        <div class="ord-w dragdot"></div>        <div class="ord-nw dragdot"></div>        <div class="ord-ne dragdot"></div>        <div class="ord-sw dragdot"></div>        <div class="ord-se dragdot"></div>    </div></div>';a.put("ngImgMap.html",b)}])}(angular),function(a,b){"function"==typeof define&&define.amd?define(["jquery"],b):b(a.jQuery)}(this,function(a){var b,c,d,e,f,g,h,j,k,l,m;if(c=!!document.createElement("canvas").getContext,b=function(){var a=document.createElement("div");a.innerHTML='<v:shape id="vml_flag1" adj="1" />';var b=a.firstChild;return b.style.behavior="url(#default#VML)",b?"object"==typeof b.adj:!0}(),!c&&!b)return void(a.fn.maphilight=function(){return this});if(c){j=function(a){return Math.max(0,Math.min(parseInt(a,16),255))},k=function(a,b){return"rgba("+j(a.substr(0,2))+","+j(a.substr(2,2))+","+j(a.substr(4,2))+","+b+")"},d=function(b){var c=a('<canvas style="width:'+a(b).width()+"px;height:"+a(b).height()+'px;"></canvas>').get(0);return c.getContext("2d").clearRect(0,0,a(b).width(),a(b).height()),c};var n=function(a,b,c,d,e){if(d=d||0,e=e||0,a.beginPath(),"rect"==b)a.rect(c[0]+d,c[1]+e,c[2]-c[0],c[3]-c[1]);else if("poly"==b)for(a.moveTo(c[0]+d,c[1]+e),i=2;i<c.length;i+=2)a.lineTo(c[i]+d,c[i+1]+e);else"circ"==b&&a.arc(c[0]+d,c[1]+e,c[2],0,2*Math.PI,!1);a.closePath()};e=function(b,c,d,e,f){var g=b.getContext("2d");if(e.shadow){g.save(),"inside"==e.shadowPosition&&(n(g,c,d),g.clip());var h=100*b.width,i=100*b.height;n(g,c,d,h,i),g.shadowOffsetX=e.shadowX-h,g.shadowOffsetY=e.shadowY-i,g.shadowBlur=e.shadowRadius,g.shadowColor=k(e.shadowColor,e.shadowOpacity);var j=e.shadowFrom;j||(j="outside"==e.shadowPosition?"fill":"stroke"),"stroke"==j?(g.strokeStyle="rgba(0,0,0,1)",g.stroke()):"fill"==j&&(g.fillStyle="rgba(0,0,0,1)",g.fill()),g.restore(),"outside"==e.shadowPosition&&(g.save(),n(g,c,d),g.globalCompositeOperation="destination-out",g.fillStyle="rgba(0,0,0,1);",g.fill(),g.restore())}g.save(),n(g,c,d),e.fill&&(g.fillStyle=k(e.fillColor,e.fillOpacity),g.fill()),e.stroke&&(g.strokeStyle=k(e.strokeColor,e.strokeOpacity),g.lineWidth=e.strokeWidth,g.stroke()),g.restore(),e.fade&&a(b).css("opacity",0).animate({opacity:1},100)},f=function(a){a.getContext("2d").clearRect(0,0,a.width,a.height)}}else d=function(b){return a('<var style="zoom:1;overflow:hidden;display:block;width:'+b.width+"px;height:"+b.height+'px;"></var>').get(0)},e=function(b,c,d,e,f){var g,h,i,j;for(var k in d)d[k]=parseInt(d[k],10);g='<v:fill color="#'+e.fillColor+'" opacity="'+(e.fill?e.fillOpacity:0)+'" />',h=e.stroke?'strokeweight="'+e.strokeWidth+'" stroked="t" strokecolor="#'+e.strokeColor+'"':'stroked="f"',i='<v:stroke opacity="'+e.strokeOpacity+'"/>',"rect"==c?j=a('<v:rect name="'+f+'" filled="t" '+h+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+d[0]+"px;top:"+d[1]+"px;width:"+(d[2]-d[0])+"px;height:"+(d[3]-d[1])+'px;"></v:rect>'):"poly"==c?j=a('<v:shape name="'+f+'" filled="t" '+h+' coordorigin="0,0" coordsize="'+b.width+","+b.height+'" path="m '+d[0]+","+d[1]+" l "+d.join(",")+' x e" style="zoom:1;margin:0;padding:0;display:block;position:absolute;top:0px;left:0px;width:'+b.width+"px;height:"+b.height+'px;"></v:shape>'):"circ"==c&&(j=a('<v:oval name="'+f+'" filled="t" '+h+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+(d[0]-d[2])+"px;top:"+(d[1]-d[2])+"px;width:"+2*d[2]+"px;height:"+2*d[2]+'px;"></v:oval>')),j.get(0).innerHTML=g+i,a(b).append(j)},f=function(b){var c=a("<div>"+b.innerHTML+"</div>");c.children("[name=highlighted]").remove(),b.innerHTML=c.html()};g=function(a){var b,c=a.getAttribute("coords").split(",");for(b=0;b<c.length;b++)c[b]=parseFloat(c[b]);return[a.getAttribute("shape").toLowerCase().substr(0,4),c]},m=function(b,c){var d=a(b);return a.extend({},c,a.metadata?d.metadata():!1,d.data("maphilight"))},l=function(a){return a.complete?"undefined"!=typeof a.naturalWidth&&0===a.naturalWidth?!1:!0:!1},h={position:"absolute",left:0,top:0,padding:0,border:0};var o=!1;a.fn.maphilight=function(i){return i=a.extend({},a.fn.maphilight.defaults,i),c||o||(a(window).ready(function(){document.namespaces.add("v","urn:schemas-microsoft-com:vml");var b=document.createStyleSheet(),c=["shape","rect","oval","circ","fill","stroke","imagedata","group","textbox"];a.each(c,function(){b.addRule("v\\:"+this,"behavior: url(#default#VML); antialias:true")})}),o=!0),this.each(function(){var j,k,n,o,p,q,r;if(j=a(this),!l(this))return window.setTimeout(function(){j.maphilight(i)},200);if(n=a.extend({},i,a.metadata?j.metadata():!1,j.data("maphilight")),r=j.get(0).getAttribute("usemap"),r&&(o=a('map[name="'+r.substr(1)+'"]'),j.is('img,input[type="image"]')&&r&&o.length>0)){if(j.hasClass("maphilighted")){var s=j.parent();j.insertBefore(s),s.remove(),a(o).unbind(".maphilight")}k=a("<div></div>").css({display:"block",backgroundImage:'url("'+this.src+'")',backgroundSize:"contain",position:"relative",padding:0,width:this.width,height:this.height}),n.wrapClass&&(n.wrapClass===!0?k.addClass(a(this).attr("class")):k.addClass(n.wrapClass)),j.before(k).css("opacity",1e-10).css(h).remove(),b&&j.css("filter","Alpha(opacity=0)"),k.append(j),p=d(this),a(p).css(h),p.height=this.height,p.width=this.width,a(o).bind("alwaysOn.maphilight",function(){q&&f(q),c||a(p).empty(),a(o).find("area[coords]").each(function(){var b,f;f=m(this,n),f.alwaysOn&&(!q&&c&&(q=d(j[0]),a(q).css(h),q.width=j[0].width,q.height=j[0].height,j.before(q)),f.fade=f.alwaysOnFade,b=g(this),c?e(q,b[0],b[1],f,""):e(p,b[0],b[1],f,""))})}).trigger("alwaysOn.maphilight").bind("mouseover.maphilight, focusin.maphilight",function(b){var d,f,h=b.target;if(f=m(h,n),!f.neverOn&&!f.alwaysOn){if(d=g(h),e(p,d[0],d[1],f,"highlighted"),f.groupBy){var i;i=/^[a-zA-Z][\-a-zA-Z]+$/.test(f.groupBy)?o.find("area["+f.groupBy+'="'+a(h).attr(f.groupBy)+'"]'):o.find(f.groupBy);var j=h;i.each(function(){if(this!=j){var a=m(this,n);if(!a.neverOn&&!a.alwaysOn){var b=g(this);e(p,b[0],b[1],a,"highlighted")}}})}c||a(p).append("<v:rect></v:rect>")}}).bind("mouseout.maphilight, focusout.maphilight",function(a){f(p)}),j.before(p),j.addClass("maphilighted")}})},a.fn.maphilight.defaults={fill:!0,fillColor:"000000",fillOpacity:.2,stroke:!0,strokeColor:"ff0000",strokeOpacity:1,strokeWidth:1,fade:!0,alwaysOn:!1,neverOn:!1,groupBy:!1,wrapClass:!0,shadow:!1,shadowX:0,shadowY:0,shadowRadius:6,shadowColor:"000000",shadowOpacity:.8,shadowPosition:"outside",shadowFrom:!1}});var app=angular.module("imageTaggingApp");app.controller("DemoCtrl",["$scope","fileReader",function(a,b){function c(a){var b=new RegExp("(\\d+)x(\\d+)."),c=b.exec(a);return c&&c.length>1?c.slice(1):!1}a.imageSrc=" ",a.$on("fileProgress",function(b,c){a.progress=c.loaded/c.total}),a.img={pic_url:"images/map.8ecd1615.png"},a.showType=function(b){a.name=b,alert(a.name+" clicked")},a.mapFns={getCanSize:function(){return[950,1e3]},getImgSize:function(b){return c(a.img.pic_url)||[550,400]}},a.addArea=function(a){a&&a.maps&&angular.isArray(a.maps)||(a=angular.isObject(a)?a:{},a.maps=[]);var b=a.getCalculation(),c=a.maps.slice(-1)[0],d=c?c.coords[0]:0,e=c?c.coords[1]:0,f=[d+30,e+30,d+100,e+100];b?a.maps.push({coords:b.checkCoords(f)}):a.maps.push({coords:f})},a.catchArea=function(a){a.isDraging=!0},a.releaseArea=function(a){a.hasOwnProperty("isDraging")&&delete a.isDraging},a.$watch("img",function(b,c){a.imgJson=angular.toJson(b,!0)},!0)}]),app.directive("ngFileSelect",["fileReader","$timeout",function(a,b){return{scope:{ngModel:"="},link:function(c,d){function e(d){a.readAsDataUrl(d,c).then(function(a){b(function(){c.ngModel=a})})}d.bind("change",function(a){var b=(a.srcElement||a.target).files[0];e(b)})}}}]),app.factory("fileReader",["$q","$log",function(a,b){var c=function(a,b,c){return function(){c.$apply(function(){b.resolve(a.result)})}},d=function(a,b,c){return function(){c.$apply(function(){b.reject(a.result)})}},e=function(a,b){return function(a){b.$broadcast("fileProgress",{total:a.total,loaded:a.loaded})}},f=function(a,b){var f=new FileReader;return f.onload=c(f,a,b),f.onerror=d(f,a,b),f.onprogress=e(f,b),f},g=function(b,c){var d=a.defer(),e=f(d,c);return e.readAsDataURL(b),d.promise};return{readAsDataUrl:g}}]),angular.module("imageTaggingApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("imageTaggingApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/main.html",'<div class="container"> <div class="row"> <div class="col-md-6"> <form> <!-- <input type="file" ng-file-select="onFileSelect($files)" ng-model="imageSrc"> --> <!--  <input type="file" ng-file-select="onFileSelect($files)" multiple> --> </form> </div> <div class="col-md-6"> <img ng-src="{{imageSrc}}" class="img-responsive"> </div> </div> </div> <div class="col-md-6"> <div ng-img-map ng-img-map-fns="mapFns" ng-model="img"></div> <div class="row" style="padding:0px 50px"> <button class="btn btn-success" ng-click="addArea(img)" style="margin-top: 20px">add area</button> <div class="col-md-12"> <div class="col-md-12" ng-repeat="m in img.maps" style="margin: 5px 0"> <div class="row"> <div class="pull-left"> <h5>Area {{$index+1}}: </h5></div> <div class="col-md-5"> <label class="block" for="">Title</label> <input class="form-control" type="text" ng-model="m.title" ng-focus="catchArea(m)" ng-blur="releaseArea(m)"> </div> <div class="col-md-5"> <label class="block" for="">Description</label> <input class="form-control" type="text" ng-model="m.description" ng-focus="catchArea(m)" ng-blur="releaseArea(m)"> </div> </div> </div> </div> </div> </div> <div class="col-md-6"> <!-- <div>Live Data</div>\n  <pre>{{imgJson}}</pre> --> <div style="text-align:center"> <div> <img class="map" ng-src="{{img.pic_url}}" class="demo-img" usemap="#ImgExam"> <map name="ImgExam" style="position:relative"> <area class="area" ng-click="showType(area.title)" style="outline: #000 solid 2px" shape="rect" coords="{{area.coords.join()}}" ng-repeat="area in img.maps" ng-href="{{area.link_url || \'javascript:void(0)\'}}" title="{{area.title}}" target="_blank"> </map> </div> </div> </div> <script type="text/javascript">$(function() {\n  $(\'.map\').maphilight({fade: false});\n});</script> <!-- <script src="scripts/controllers/maphilight.js"></script> --> <!-- <script type="text/javascript">\n'+"  angular.module('map', ['maphilights']);\n</script> -->")}]);